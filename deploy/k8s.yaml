# New-API Kubernetes Deployment
# Namespace: lurus-system
# Domain: newapi.lurus.cn
# Source: https://github.com/QuantumNous/new-api
# Node: lurus.cn/vpn=true (proxy enabled for Gemini access)

---
# Redis Deployment (shared cache for lurus-system)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: lurus-system
  labels:
    app: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"

---
# Redis Service
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: lurus-system
  labels:
    app: redis
spec:
  selector:
    app: redis
  ports:
    - port: 6379
      targetPort: 6379
  type: ClusterIP

---
# Secret for database credentials
apiVersion: v1
kind: Secret
metadata:
  name: lurus-newapi-secret
  namespace: lurus-system
  labels:
    app: lurus-newapi
type: Opaque
stringData:
  SQL_DSN: "postgresql://lurus:LurusOps2026@lurus-pg-rw.database.svc:5432/newapi?sslmode=disable"
  REDIS_CONN_STRING: "redis://redis.lurus-system.svc:6379/0"
  SESSION_SECRET: "lurus-newapi-session-secret-2026"

---
# PersistentVolumeClaim for data storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lurus-newapi-data
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: local-path

---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lurus-newapi
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lurus-newapi
  template:
    metadata:
      labels:
        app: lurus-newapi
    spec:
      # Schedule on proxy-enabled node for Gemini API access
      nodeSelector:
        lurus.cn/vpn: "true"
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      containers:
        - name: lurus-newapi
          # Built from this fork (ghcr.io/hanmahong5-arch/lurus-newapi)
          image: ghcr.io/hanmahong5-arch/lurus-newapi:main
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: [ALL]
          imagePullPolicy: IfNotPresent
          args:
            - --log-dir
            - /app/logs
          ports:
            - containerPort: 3000
              name: http
          env:
            - name: TZ
              value: "Asia/Shanghai"
            - name: SQL_DSN
              valueFrom:
                secretKeyRef:
                  name: lurus-newapi-secret
                  key: SQL_DSN
            - name: REDIS_CONN_STRING
              valueFrom:
                secretKeyRef:
                  name: lurus-newapi-secret
                  key: REDIS_CONN_STRING
            - name: SESSION_SECRET
              valueFrom:
                secretKeyRef:
                  name: lurus-newapi-secret
                  key: SESSION_SECRET
            - name: ERROR_LOG_ENABLED
              value: "true"
            - name: BATCH_UPDATE_ENABLED
              value: "true"
            - name: MEMORY_CACHE_ENABLED
              value: "true"
            - name: STREAMING_TIMEOUT
              value: "300"
            - name: RELAY_TIMEOUT
              value: "300"
            # Outbound proxy for external LLM API access (Gemini, etc.)
            - name: HTTP_PROXY
              value: "http://10.42.1.1:10808"
            - name: HTTPS_PROXY
              value: "http://10.42.1.1:10808"
            - name: NO_PROXY
              value: "localhost,127.0.0.1,::1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,100.64.0.0/10,*.svc,*.svc.cluster.local,lurus.cn,*.lurus.cn"
            - name: http_proxy
              value: "http://10.42.1.1:10808"
            - name: https_proxy
              value: "http://10.42.1.1:10808"
            - name: no_proxy
              value: "localhost,127.0.0.1,::1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,100.64.0.0/10,*.svc,*.svc.cluster.local,lurus.cn,*.lurus.cn"
          volumeMounts:
            - name: data
              mountPath: /data
            - name: logs
              mountPath: /app/logs
            - name: tmp
              mountPath: /tmp
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /api/status
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/status
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: lurus-newapi-data
        - name: logs
          emptyDir: {}
        - name: tmp
          emptyDir: {}

---
# Service
apiVersion: v1
kind: Service
metadata:
  name: lurus-newapi
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  selector:
    app: lurus-newapi
  ports:
    - name: http
      port: 3000
      targetPort: 3000
  type: ClusterIP

---
# IngressRoute for Traefik
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: lurus-newapi-route
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`newapi.lurus.cn`)
      kind: Rule
      middlewares:
        - name: global-ratelimit
          namespace: lurus-system
        - name: circuit-breaker
          namespace: lurus-system
      services:
        - name: lurus-newapi
          port: 3000
  tls:
    secretName: lurus-cn-wildcard-tls
