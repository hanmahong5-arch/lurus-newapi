# New-API Kubernetes Deployment
# Namespace: lurus-system
# Domain: newapi.lurus.cn
# Source: https://github.com/QuantumNous/new-api
# Node: office-debian-2 (proxy enabled for Gemini access)

---
# Redis Deployment (shared cache for lurus-system)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: lurus-system
  labels:
    app: redis
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      # Schedule on proxy-enabled node for network access
      nodeSelector:
        kubernetes.io/hostname: office-debian-2
      containers:
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"

---
# Redis Service
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: lurus-system
  labels:
    app: redis
spec:
  selector:
    app: redis
  ports:
    - port: 6379
      targetPort: 6379
  type: ClusterIP

---
# Secret for database credentials
# NOTE: Using ClusterIP addresses because office-debian-2 has DNS resolution issues
# PostgreSQL ClusterIP: 10.43.9.14 (lurus-pg-rw.database.svc)
# Redis ClusterIP: 10.43.90.36 (redis.lurus-system.svc)
apiVersion: v1
kind: Secret
metadata:
  name: lurus-newapi-secret
  namespace: lurus-system
  labels:
    app: lurus-newapi
type: Opaque
stringData:
  # PostgreSQL connection (using ClusterIP due to DNS issues on office-debian-2)
  SQL_DSN: "postgresql://lurus:LurusOps2026@10.43.9.14:5432/newapi?sslmode=disable"
  # Redis connection (using ClusterIP due to DNS issues on office-debian-2)
  REDIS_CONN_STRING: "redis://10.43.90.36:6379/0"
  # Session secret - random string for session encryption
  SESSION_SECRET: "lurus-newapi-session-secret-2026"

---
# PersistentVolumeClaim for data storage
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lurus-newapi-data
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: local-path

---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lurus-newapi
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: lurus-newapi
  template:
    metadata:
      labels:
        app: lurus-newapi
    spec:
      # Schedule on proxy-enabled node for Gemini API access
      nodeSelector:
        kubernetes.io/hostname: office-debian-2
      containers:
        - name: lurus-newapi
          image: calciumion/new-api:latest
          imagePullPolicy: Always
          args:
            - --log-dir
            - /app/logs
          ports:
            - containerPort: 3000
              name: http
          env:
            - name: TZ
              value: "Asia/Shanghai"
            - name: SQL_DSN
              valueFrom:
                secretKeyRef:
                  name: lurus-newapi-secret
                  key: SQL_DSN
            - name: REDIS_CONN_STRING
              valueFrom:
                secretKeyRef:
                  name: lurus-newapi-secret
                  key: REDIS_CONN_STRING
            - name: SESSION_SECRET
              valueFrom:
                secretKeyRef:
                  name: lurus-newapi-secret
                  key: SESSION_SECRET
            - name: ERROR_LOG_ENABLED
              value: "true"
            - name: BATCH_UPDATE_ENABLED
              value: "true"
            - name: MEMORY_CACHE_ENABLED
              value: "true"
            - name: STREAMING_TIMEOUT
              value: "300"
          volumeMounts:
            - name: data
              mountPath: /data
            - name: logs
              mountPath: /app/logs
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /api/status
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/status
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: lurus-newapi-data
        - name: logs
          emptyDir: {}

---
# Service
apiVersion: v1
kind: Service
metadata:
  name: lurus-newapi
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  selector:
    app: lurus-newapi
  ports:
    - name: http
      port: 3000
      targetPort: 3000
  type: ClusterIP

---
# IngressRoute for Traefik
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: lurus-newapi-route
  namespace: lurus-system
  labels:
    app: lurus-newapi
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`newapi.lurus.cn`)
      kind: Rule
      services:
        - name: lurus-newapi
          port: 3000
  tls:
    certResolver: letsencrypt
